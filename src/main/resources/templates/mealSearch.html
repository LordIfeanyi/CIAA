<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meal Search</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" />
  <link href="mealSearch.css" rel="stylesheet" />
</head>

<style>
  body {
    background-image: url("food1.jpg");

    /* Add some basic styling */
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
  }

  ul {
    list-style-type: none;
    padding: 0;
  }

  li {
    padding: 10px;
    background-color: #f0f0f0;
    margin-bottom: 5px;
    position: relative;
  }

  li:hover {
    background-color: #e0e0e0;
  }

  /* Hide dropdown content by default */
  .dropdown-content {
    display: none;
  }

  /* Show dropdown content when the dropdown is active */
  .dropdown-active .dropdown-content {
    display: block;
  }

  /* Style for the save button */
  .save-button {
    position: absolute;
    top: 5px;
    right: 5px;
    cursor: pointer;
    color: green;
  }
</style>

<body>
  <div class="container mt-5">
    <h1 class="text-center mb-4">Search for Meals</h1>
    <div class="mb-3">
      <label for="query" class="form-label">Enter name of the meal:</label>
      <input type="text" id="query" class="form-control" placeholder="Enter your search query" required>
    </div>

    <br />

    <legend>Choose a cuisine: (optional)</legend>
    <div id="CuisineOptions">
      <label><input type="radio" name="cuisine" value="African" /> African</label>
      <label><input type="radio" name="cuisine" value="Asian" /> Asian</label>
      <label><input type="radio" name="cuisine" value="American" /> American</label>
      <label><input type="radio" name="cuisine" value="Caribbean" /> Caribbean</label>
      <label><input type="radio" name="cuisine" value="Chinese" /> Chinese</label>
      <label><input type="radio" name="cuisine" value="French" /> French</label>
      <label><input type="radio" name="cuisine" value="Greek" /> Greek</label>
      <label><input type="radio" name="cuisine" value="Indian" /> Indian</label>
      <label><input type="radio" name="cuisine" value="Italian" /> Italian</label>
      <label><input type="radio" name="cuisine" value="Japanese" /> Japanese</label>
      <label><input type="radio" name="cuisine" value="Korean" /> Korean</label>
      <label><input type="radio" name="cuisine" value="Mediterranean" /> Mediterranean</label>
      <label><input type="radio" name="cuisine" value="Mexican" /> Mexican</label>
      <label><input type="radio" name="cuisine" value="Spanish" /> Spanish</label>
      <label><input type="radio" name="cuisine" value="Thai" /> Thai</label>
      <label><input type="radio" name="cuisine" value="Vietnamese" /> Vietnamese</label>

      <button id="clearTypeSelection" onclick="clearRadioButtons('cuisine')">Clear</button>
    </div>
    <br />

    <legend>Choose a diet: (optional)</legend>
    <div id="DietOptions">
      <label><input type="radio" name="diet" value="Gluten Free" /> Gluten Free</label>
      <label><input type="radio" name="diet" value="Vegetarian" /> Vegetarian</label>
      <label><input type="radio" name="diet" value="Vegan" /> Vegan</label>
      <label><input type="radio" name="diet" value="Pescetarian" /> Pescetarian</label>
      <label><input type="radio" name="diet" value="Paleo" /> Paleo</label>
      <label><input type="radio" name="diet" value="Primal" /> Primal</label>

      <button id="clearTypeSelection" onclick="clearRadioButtons('diet')">Clear</button>
    </div>
    <br />
    <!-- <br /> -->

    <legend>Choose a meal type: (optional)</legend>
    <div id="CuisineOptions">
      <label><input type="radio" name="type" value="main course" /> Main course</label>
      <label><input type="radio" name="type" value="side dish" /> Side dish</label>
      <label><input type="radio" name="type" value="dessert" /> Dessert</label>
      <label><input type="radio" name="type" value="appetizer" /> Appetizer</label>
      <label><input type="radio" name="type" value="breakfast" /> Breakfast</label>
      <label><input type="radio" name="type" value="beverage" /> Beverage</label>
      <label><input type="radio" name="type" value="snack" /> Snack</label>

      <button id="clearTypeSelection" onclick="clearRadioButtons('type')">Clear</button>
    </div>
    <br />

    <legend>Choose any number of intolerances: (optional)</legend>
    <div id="IntoleranceOptions">
      <label><input type="checkbox" name="intolerance" value="Dairy" /> Dairy</label>
      <label><input type="checkbox" name="intolerance" value="Egg" /> Egg</label>
      <label><input type="checkbox" name="intolerance" value="Gluten" /> Gluten</label>
      <label><input type="checkbox" name="intolerance" value="Grain" /> Grain</label>
      <label><input type="checkbox" name="intolerance" value="Peanut" /> Peanut</label>
      <label><input type="checkbox" name="intolerance" value="Seafood" /> Seafood</label>
      <label><input type="checkbox" name="intolerance" value="Sesame" /> Sesame</label>
      <label><input type="checkbox" name="intolerance" value="Shellfish" /> Shellfish</label>
      <label><input type="checkbox" name="intolerance" value="Soy" /> Soy</label>
      <label><input type="checkbox" name="intolerance" value="Sulfite" /> Sulfite</label>
      <label><input type="checkbox" name="intolerance" value="Tree Nut" /> Tree Nut</label>
      <label><input type="checkbox" name="intolerance" value="Wheat" /> Wheat</label>

      <button id="clearTypeSelection" onclick="clearCheckBoxes()">Clear</button>
    </div>

    <div class="search-button-container">
      <button onclick="generateList()">Search</button>


    </div>

    <div class="button-container">
      <a href="homePage"><button id="homeButton">Back to Home Page</button></a>
    </div>

    <ul id="searchResults">
      <!-- List items will be generated dynamically here using JavaScript -->
    </ul>

    <script>

      function clearRadioButtons(name) {
        checkedRadioButton = document.querySelector('input[name="' + name + '"]:checked');
        checkedRadioButton.checked = false;
      }

      function clearCheckBoxes() {
        var checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
        checkboxes.forEach(function (checkbox) {
          checkbox.checked = false;
        });

      }

      async function generateList() {

        // get the div to be dynamically populated with items
        var itemList = document.getElementById("searchResults");
        itemList.innerHTML = '';

        // get the values to be appended to the endpoint
        var query = document.getElementById("query").value;
        var cuisine = null;
        var diet = null;
        var type = null;
        var intolerances = [];
        if (document.querySelector('input[name="cuisine"]:checked') !== null) {
          cuisine = document.querySelector('input[name="cuisine"]:checked').value;
        }
        if (document.querySelector('input[name="diet"]:checked') !== null) {
          diet = document.querySelector('input[name="diet"]:checked').value;
        }
        if (document.querySelector('input[name="type"]:checked') !== null) {
          type = document.querySelector('input[name="type"]:checked').value;
        }
        var checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
        checkboxes.forEach(function (checkbox) {
          intolerances.push(checkbox.value);
        });

        // build the endpoint
        var url = 'https://api.spoonacular.com/recipes/complexSearch?apiKey=9fd619b00abb41b5ae7305ea3b06d2f3'
        if (query) {
          url += '&query=' + encodeURIComponent(query);
        }
        if (cuisine) {
          url += '&cuisine=' + encodeURIComponent(cuisine);
        }
        if (diet) {
          url += '&diet=' + encodeURIComponent(diet);
        }
        if (type) {
          url += '&type=' + encodeURIComponent(type);
        }
        if (intolerances.length !== 0) {
          url += '&intolerances=' + encodeURIComponent(intolerances.join(','));
        }

        // print the endpoint to check
        console.log("spoonacular request url = ", url);

        // fetch the items by calling the spoonacular endpoint
        const recipes = await fetchSearchResults(url); // fetch method

        var results = recipes.results;

        // if no results came back
        if (results.length == 0) {
          var noResults = document.createElement("div");
          noResults.textContent = "No results were found. Try making your search less specific.";
          itemList.appendChild(noResults);
          return;
        }

        results.forEach(async (result) => {

          // make a new list item using the data
          var li = document.createElement("li");
          li.textContent = result.title;
          var dropdownContent = document.createElement("div");
          dropdownContent.className = "dropdown-content";
          dropdownContent.textContent = result.id;
          var saveButton = document.createElement("span");
          saveButton.className = "save-button";
          saveButton.textContent = "Save";

          // make event listeners for the save and dropdown functionality
          saveButton.addEventListener("click", function () {
            li.remove();
            saveMeal(result.id); // save method
          });
          li.addEventListener("click", function () {
            li.classList.toggle("dropdown-active");
          });

          // add the components to the li and the li to the list
          li.appendChild(dropdownContent);
          li.appendChild(saveButton);
          itemList.appendChild(li);

        });
      }

      async function fetchSearchResults(url) {
        const response = await fetch(url);
        const data = await response.json();
        return data;
      }

      // send a POST request to the backend to add this id to the currents user's saved meals
      async function saveMeal(id) {
        try {
          const response = await fetch(`/ciaa/savedmeals/${id}`, {
            method: 'POST'
          });
          if (response.ok) {
            console.log('Item saved successfully');
          } else {
            console.error('Failed to save item');
          }
        } catch (error) {
          console.error('Error saving item:', error);
        }
      }

    </script>
</body>

</html>